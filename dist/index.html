<html>
<body>

<img id="waterdepth_image"/>

<script>
  const main = async function () {
    
    console.log("3di starterkit runs");

    let simulationObj = {};
    // set id if using an exisiting simulation instead of opening a new one
    simulationObj.id = 8268;

    // _____________________________________________________________ START CREATING NEW SIMULATION
    if (!simulationObj.id) {
      // create simulation
      const body = {
        name:"v2_bergermeer_simple_infil_no_grndwtr_2021-04-06T144924",
        threedimodel:"575", // id of the threedi model
        organisation:"b08433fa47c1401eb9cbd4156034c679", // uuid of your organisation
        start_datetime:"2021-04-06T12:49:24.063Z", // current time
        duration: 60*60,
      }
      const simulationResponse = await fetch("https://api.staging.3di.live/v3.0/simulations/", {
        method: 'POST', 
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body),
      });
      simulationObj = await simulationResponse.json();
      console.log('simulationObj', simulationObj);

      // initialize simulation
      const actionResponse = await fetch(`https://api.staging.3di.live/v3.0/simulations/${simulationObj.id}/actions/`, {
        method: 'POST', 
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name:"initialize",
          timeout:1800
        }),
      });
      const actionObj = await actionResponse.json();
      console.log('actionObj', actionObj);
    }
    // _____________________________________________________________ END CREATING NEW SIMULATION
    

    // _____________________________________________________________ START MAIN WEBSOCKET
    // connect websocket
    const mainWebSocket = new WebSocket(`wss://api.staging.3di.live/v3.0/simulations/${simulationObj.id}/?initial_events=true&visualization=true`);
    // const mainWebSocket = new WebSocket(`wss://api.staging.3di.live/v3.0/simulations/8262/?initial_events=true&visualization=true`);

    // keep sending heartbeat to keep simulation running
    mainWebSocket.onopen = function (event) {
      mainWebSocket.send(JSON.stringify({event_name: "heartbeat"}));
      window.setInterval(()=>{
        mainWebSocket.send(JSON.stringify({event_name: "heartbeat"}));
      }, 100000)
    };

    mainWebSocket.onmessage = async function (event) {
      console.log('12323',  event.data);
      

      // _____________________________________________________________ START WATERDEPTH WEBSOCKET
      const parsedData = JSON.parse(event.data)
      if (
        parsedData &&
        parsedData.type == "visualization" &&
        parsedData.data &&
        parsedData.data.layer === "waterdepth"
      ) {
        console.log("open waterdepth websocket");

        const websocketRequest = await fetch (`https://api.staging.3di.live/v3.0/simulations/${simulationObj.id}/visualisations/waterdepth/`, {
          method: 'GET', 
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          },
        })
        const parsedWebsocketUrlRequest = await websocketRequest.json();

        const waterdepthWebsocket = new WebSocket(parsedWebsocketUrlRequest.websocket_url);

        waterdepthWebsocket.onopen = function (event) {
          waterdepthWebsocket.send(JSON.stringify({"width":944,"height":919,"crs":"EPSG3857","bbox":[508726.64175199065,6899855.887760434,544804.9191025938,6934978.702257474]}));
        }
        waterdepthWebsocket.onmessage = async function (event) {
          console.log('waterdepth message', event.data);

          // The first 2 bytes say what kind of message this is.
          const type = event.data.slice(0, 2);
          const rest = event.data.slice(2);
          const typeText = await type.text();
          // other possible message types that are not 2d waterdepth data
          // if (typeText === '1d') {
          //   console.log('1d blob message')
          // }
          // if (typeText === 'pu') {
          //   console.log('pump blob message')
          // }
          // _____________________________________________________________ START WATERDEPTH 2d DATA HANDLING
          if (typeText === '2d') {
            console.log('2d blob message');

              // The blob is a 40-byte header containing timing and bounds
              // information, plus an image.

              const header = rest.slice(0, 40);
              const image = rest.slice(40);

              const headerBuffer = await header.arrayBuffer();
              const headerArray = new Float64Array(headerBuffer);

              const timing = headerArray[0];
              
              // Use leaflet to extract the projection
              // const sw = Leaflet.Projection.SphericalMercator.unproject(
              //   Leaflet.point(headerArray[1], headerArray[2])
              // );
              // const ne = Leaflet.Projection.SphericalMercator.unproject(
              //   Leaflet.point(headerArray[3], headerArray[4])
              // );
              // const data_bounds = Leaflet.latLngBounds(sw, ne);

              const objectUrl = window.URL.createObjectURL(image);

              const imgElement = document.getElementById("waterdepth_image");
              console.log('image element', imgElement);
              imgElement.src = objectUrl;
              imgElement.onload = (function(){
                console.log('2d image waterdepth loaded');
                
                // send to websocket that image was processed. Thus ready to receive new image
                window.setTimeout(function(){
                  waterdepthWebsocket.send(JSON.stringify({"processed": timing}));
                },3000)
              });
          }
        }
      }
    }
  }

  main();

</script>

</body>
</html>